# 多文件合并处理功能说明

## 新增需求概述

本次更新主要增加了对多文件上传和处理的支持，使系统能够同时处理多个时间段的数据，并进行合并分析。此功能极大地提升了数据处理的效率和便捷性，无需再为每个时间段的数据单独进行处理。

## 数据准备

### 支持多文件上传的数据类型

以下数据类型支持同时上传多个文件（不同时间段）进行合并处理：

1. **科室药品使用金额及使用量DDDs排名表**
   - 文件格式: Excel (.xlsx)
   - 示例1: `科室药品使用金额及使用量DDDs排名表2025.5.xlsx`、`科室药品使用金额及使用量DDDs排名表2025.6.xlsx`
   - 示例2: `2025.5.xlsx`、`2025.6.xlsx`

2. **门(急)诊病人指标(科室)**
   - 文件格式: Excel (.xlsx)
   - 示例1: `门(急)诊病人指标(科室)2025.5.xlsx`、`门(急)诊病人指标(科室)2025.6.xlsx`
   - 示例2: `2025.5.xlsx`、`2025.6.xlsx`

3. **住(出)院病人指标(科室)**
   - 文件格式: Excel (.xlsx)
   - 示例1: `住(出)院病人指标(科室)2025.5.xlsx`、`住(出)院病人指标(科室)2025.6.xlsx`
   - 示例2: `2025.5.xlsx`、`2025.6.xlsx`

4. **住院患者静脉输液使用监测指标调查表**
   - 文件格式: Excel (.xlsx)
   - 示例1: `住院患者静脉输液使用监测指标调查表2025.5.xlsx`、`住院患者静脉输液使用监测指标调查表2025.6.xlsx`
   - 示例2: `2025.5.xlsx`、`2025.6.xlsx`

### 仅支持单文件上传的数据类型

以下数据类型仍然只支持单文件上传：

1. **公立医疗机构药品目录**
   - 文件格式: Excel (.xlsx)
   - 示例: `公立医疗机构药品目录.xlsx`

2. **科室架构表**
   - 文件格式: Excel (.xlsx)
   - 示例: `科室结构总表.xlsx`

## 数据文件夹结构示例

```
data/
├── 科室药品使用金额及使用量DDDs排名表/
│   ├── 科室药品使用金额及使用量DDDs排名表2025.5.xlsx
│   ├── 科室药品使用金额及使用量DDDs排名表2025.6.xlsx
│
├── 门急诊人次/
│   ├── 门(急)诊病人指标(科室)2025.5.xlsx
│   ├── 门(急)诊病人指标(科室)2025.6.xlsx
│
├── 输液/
│   ├── 住院患者静脉输液使用监测指标调查表2025.5.xlsx
│   ├── 住院患者静脉输液使用监测指标调查表2025.6.xlsx
│
├── 住院人次/
│   ├── 住(出)院病人指标(科室)2025.5.xlsx
│   ├── 住(出)院病人指标(科室)2025.6.xlsx
│
├── 公立医疗机构药品目录.xlsx  (单文件)
```

## 数据处理说明

### 多文件命名与格式要求

1. **文件命名规范**
   - 文件名需包含年月信息，如：`XXX2025.5.xlsx`、`XXX2025.6.xlsx`
   - 系统会自动从文件名中提取时间信息，并在合并后的数据中保留时间维度
   - **重要变更**：输入多文件时，不需要手动输入时间，系统将自动从文件名中提取，无需验证

2. **文件格式一致性**
   - 同类型的多个文件应具有相同的数据结构（列名、格式等）
   - 支持通平台1.4、1.5和1.6版本的数据格式

### 数据合并流程

1. **数据读取与预处理**
   - 系统读取多个文件，自动识别文件类型和时间信息
   - 对每个文件进行标准化预处理，统一格式

2. **时间维度保留**
   - 合并后的数据会保留原始时间信息
   - 在结果中可按时间段分别查看数据

3. **科室匹配与数据关联**
   - 系统会根据科室ID和时间信息进行精确匹配
   - 确保不同时间段的数据正确关联到对应的科室和时间

4. **人次数据匹配**
   - 门诊和住院人次数据会根据科室名称和时间进行匹配

5. **住院天数计算**
   - 基于住院患者静脉输液监测表计算平均住院天数和总人天数
   - 按科室和时间维度进行匹配计算

### 输出结果

1. **合并后的数据表**
   - 包含所有时间段的数据
   - 保留时间维度，可按时间筛选查看

2. **数据分析结果**
   - 提供按科室、时间的多维度分析
   - 支持导出Excel格式的结果表格

## 使用优势

1. **批量处理效率**：一次性处理多个时间段的数据，节省操作时间
2. **数据完整性**：保留时间维度，便于趋势分析
3. **匹配精确度提升**：引入时间维度的匹配机制，确保数据关联的准确性
4. **操作便捷**：简化用户操作流程，提高工作效率

## 注意事项

1. 同类型的多文件应具有相同的数据结构
2. 文件名中应包含清晰的时间信息（格式如：2025.5、2025年5月）
3. 上传多文件时，系统会自动提取时间信息，无需手动输入时间
4. 建议每批处理的文件时间段连续，以便于后续分析

