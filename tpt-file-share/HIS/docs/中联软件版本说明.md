# 中联软件版本说明文档

## 📋 软件概述

中联软件数据处理工具是基于通平台数据处理工具开发的专业医疗数据标准化处理系统，专门适配中联软件的数据格式和业务需求。该工具能够将中联软件导出的医疗相关Excel文件转换为标准化的目标表格，支持复杂的科室结构识别和医保编码匹配。

## 🔧 核心功能特点

### 1. 数据处理能力
- **医疗数据标准化处理**：将中联软件导出的多个医疗相关Excel文件转换为标准化的目标表格
- **四工作表输出**：生成包含4个工作表的Excel文件
  - 医院药品信息表
  - 药品使用信息表  
  - 科室信息表（支持四级结构）
  - 药费及人次汇总表

### 2. 中联软件特色功能
- **智能数据聚合处理**：自动对药品使用明细数据按科室+药品名称进行聚类
- **动态科室结构识别**：支持四级科室结构的智能识别和分类
- **科室结构总表维护**：自动维护桌面科室结构总表，确保科室ID一致性
- **智能医保编码匹配**：通过多种算法精确匹配医保编码
- **前导零格式保护**：确保科室ID保持正确格式（如029000而非29000.0）

### 3. 用户界面特性
- **图形化界面**：基于Tkinter的友好GUI界面，集成Logo显示
- **实时日志显示**：处理过程实时显示详细日志
- **进度条显示**：可视化处理进度
- **文件自动检测**：智能查找和识别数据文件
- **版本选择支持**：支持通平台1.4和1.5版本切换

## 📁 中联软件数据要求

### 必需文件（4个）

#### 1. 药品使用信息文件
- **格式**：Excel文件（.xlsx/.xls）
- **数据来源**：中联软件药品使用模块导出的原始明细数据
- **数据特征**：
  - 跳过前2行，第3行为列名（支持智能表头检测）
  - 包含所有科室（门诊+住院）的药品使用明细数据
  - 系统会自动按科室+药品名称进行聚合处理

**必须包含的列（支持智能匹配）**：
- **接收科室**：开药科室名称
  - 智能匹配：`接收科室`、`科室名称`、`科室`等
- **药品名称**：药品完整名称
  - 智能匹配：`药品名称`、`产品名称`、`名称`等
- **实发数量**：药品实际发放数量（支持聚合求和）
  - 智能匹配：`实发数量`、`数量`、`发放数量`等
- **金额**：药品使用金额（支持聚合求和）
  - 智能匹配：`金额`、`总金额`、`使用金额`等
- **科室编码**：科室编码
  - 智能匹配：`科室编码`、`科室ID`、`科室代码`等
- **药品id**：药品唯一标识码
  - 智能匹配：`药品id`、`药品ID`、`药品编码`、`药品唯一码`等
- **规格**：药品规格
  - 智能匹配：`规格`、`制剂规格`、`药品规格`等
- **产地**：生产厂家信息
  - 智能匹配：`产地`、`厂家`、`生产厂家`等
- **单位**：计价单位
  - 智能匹配：`单位`、`计价单位`、`基本单位`等
- **批号**：药品批号
- **单价**：药品单价
- **当前库存**：当前库存数量

#### 2. 门急诊统计数据表
- **格式**：Excel文件
- **数据来源**：中联软件门急诊统计模块导出
- **包含内容**：门诊患者统计数据
- **用途**：生成药费及人次汇总表

#### 3. 住出院统计数据表
- **格式**：Excel文件
- **数据来源**：中联软件住院统计模块导出
- **包含内容**：住院患者统计数据
- **用途**：生成药费及人次汇总表

#### 4. 中联软件药品目录文件
- **格式**：Excel文件
- **数据来源**：中联软件药品目录模块导出
- **用途**：医保编码映射和药品信息匹配

**智能表头检测功能**：
- **多行检测**：自动检查前10行，寻找最佳的列名行
- **关键词匹配**：通过关键词组合进行智能匹配
  - 医保编码相关：`医保编码`、`编码`
  - 药品编码相关：`院内药品唯一码`、`药品唯一码`、`药品编码`、`唯一码`
  - 药品名称相关：`产品名称`、`药品名称`、`名称`
  - 规格相关：`制剂规格`、`规格`

**标准格式（支持智能识别）**：
- **代码**：医院药品ID（院内药品唯一码）
- **名称**：药品名称（产品名称）
- **国家医保编码**：医保编码
- **规格**：规格转换系数（默认设置为1）

### 可选文件（1个）
1. **科室结构总表**
   - 自定义科室结构，不选择时使用桌面默认表

## 📊 中联软件数据格式特点

### 数据聚合逻辑
系统会按照**接收科室+药品名称**进行数据聚合：
- **求和字段**：实发数量、金额
- **保留字段**：其他所有字段保留第一个值（科室编码、药品id、规格、产地、单位、批号、单价、当前库存）
- **输出列名映射**：
  - 接收科室 → 科室名称
  - 实发数量 → 使用量
  - 金额 → 使用金额
  - 药品id → 药品编码
  - 单位 → 计价单位
  - 产地 → 厂家

### 智能表头匹配特性
系统具有强大的**自动表头识别**功能：
- **自动跳行检测**：系统会跳过前2行，从第3行开始读取数据
- **智能列名匹配**：自动识别包含特殊字符（如换行符\n、空格）的列名
- **容错处理**：支持列名的变体形式，如"基本单位数量"、"基本单位\n数量"等
- **自动映射**：将原始列名自动映射为标准化的列名

## 🏥 中联软件科室结构识别

### 四级结构识别系统
系统采用先进的正则表达式和模式匹配算法，能够智能识别中联软件中复杂的科室层级结构：

#### 1. 四级结构识别模式
```python
# 模式1：科室名+数字+后缀
(.+?)(一|二|三|四|五|六|七|八|九|十|1|2|3|4|5|6|7|8|9|10|11|12)(病房|区|科|病区|诊室|监护室|重症|ICU|室|疗区)$

# 模式2：科室名+数字（纯数字结尾）
(.+?)(一|二|三|四|五|六|七|八|九|十|1|2|3|4|5|6|7|8|9|10|11|12)科?$

# 模式3：科室名+英文字母+后缀
(.+?)([a-zA-Z])(病房|区|科|病区|诊室|监护室|重症|ICU|室|疗区|组)$

# 模式4：科室名+英文字母（纯字母结尾）
(.+?)([a-zA-Z])$

# 模式5：科室名+数字+字母
(.+?)(一|二|三|四|五|六|七|八|九|十|1|2|3|4|5|6|7|8|9|10|11|12)([A-Z])$
```

#### 2. 中联软件科室识别示例
- **心内科一病房** → 基础科室：心内科，子单元：一病房，类型：住院
- **外科二区** → 基础科室：外科，子单元：二区，类型：住院
- **儿科1科** → 基础科室：儿科，子单元：1科，类型：住院
- **妇科A组门诊** → 基础科室：妇科，子单元：A组，类型：门诊
- **肾内科a区** → 基础科室：肾内科，子单元：a区，类型：住院

### 科室ID分配规则
- **一级结构**：全院合计 (ID: 01)
- **二级结构**：基础科室或科室组 (ID: 001, 002, ...)
- **三级结构**：具体科室类型 (ID: 0010, 0011, ...)
- **四级结构**：科室子单元 (ID: 00101, 00102, ...)

### 科室分组逻辑
- **混合科室**：同时有门诊和住院的基础科室保持独立二级结构
- **其他门诊**：仅有门诊的科室归入"其他门诊"二级结构
- **其他住院**：仅有住院的科室归入"其他住院"二级结构
- **其他病房**：仅有四级结构住院科室的基础科室归入"其他病房"二级结构

## 🎯 输出格式

### 输出文件结构
- **文件格式**：Excel文件（.xlsx）
- **工作表数量**：4个
- **默认保存位置**：输入数据文件所在目录
- **文件命名**：目标表格_时间戳.xlsx

### 各工作表内容

#### 1. 医院药品信息表
- **数据来源**：中联软件药品目录 + 药品使用信息匹配
- **列结构**：
  - A列：医保编码
  - B列：医院药品ID
  - C列：规格转换系数（默认为1）
  - D列：药品名称
  - E列：规格或规格x包装
  - F列：成本价格(元)

#### 2. 药品使用信息表
- **数据来源**：聚合处理后的药品使用信息 + 医保编码匹配
- **列结构**：
  - A列：医保编码
  - B列：医院药品ID
  - C列：科室ID
  - D列：门诊住院
  - E列：院区名
  - F列：时间
  - G列：使用量
  - H列：使用金额

#### 3. 科室信息表
- **数据来源**：科室结构识别 + 科室结构总表维护
- **列结构**：四级科室层级结构（包含单元格合并）
  - 一级结构ID、一级结构名称
  - 二级结构ID、二级结构名称
  - 三级结构ID、三级结构名称
  - 四级结构ID、四级结构名称
  - 门诊住院、院区名

#### 4. 药费及人次汇总表
- **数据来源**：药品使用信息 + 门急诊/住出院统计数据
- **内容**：按科室汇总的费用和人次统计

## ⚙️ 中联软件特殊处理机制

### 前置数据聚合处理
系统会自动对中联软件导出的药品使用信息进行聚合处理：
1. **智能读取**：跳过前2行，第3行为列名，支持智能表头检测
2. **列名识别**：自动识别包含特殊字符的列名（如换行符、空格）
3. **数据聚合**：按接收科室+药品名称分组进行聚合
4. **求和字段**：实发数量、金额
5. **保留字段**：科室编码、药品id、规格、产地、单位、批号、单价、当前库存等字段保留第一个值
6. **列名重命名**：将原始列名映射为标准化列名
7. **输出文件**：生成Drug_Use_Information_Data.xlsx

### 智能表头检测系统
系统具有多层次的智能表头检测机制：

#### 1. 药品目录文件智能检测
- **多行扫描**：自动检查前10行，寻找最佳列名行
- **关键词匹配**：基于医保编码、药品编码、药品名称等关键词
- **评分机制**：根据匹配度和有效列数进行评分
- **回退机制**：智能检测失败时自动回退到传统方式

#### 2. 药品使用信息智能列名映射
- **科室名称列**：自动识别包含"科室名称"或"科室"的列
- **药品名称列**：自动识别包含"药品名称"的列
- **药品编码列**：自动识别包含"药品编码"或"药品id"的列
- **金额列智能匹配**：
  - 优先匹配"使用金额"（精确匹配）
  - 次优匹配包含"使用金额"的列
  - 回退匹配"总金额"（排除科室总金额）
  - 最后匹配其他"金额"列（排除科室相关）
- **数量列**：自动识别包含"数量"或"实发数量"的列

#### 3. 容错处理机制
- **特殊字符处理**：自动处理列名中的换行符(\n)、空格等
- **变体识别**：支持列名的多种变体形式
- **缺失列补充**：自动为缺失的列设置默认值
- **数据类型转换**：自动进行数值类型转换和错误处理

### ID格式保护
- 确保科室ID保持前导零格式
- 防止Excel自动转换为数字格式
- 支持多种ID长度（2位、3位、4位、5位、6位）
- 特别修复四级结构ID的浮点数格式问题

### 医保编码匹配
通过中联软件药品目录进行智能医保编码匹配：
1. **智能表头检测**：自动识别药品目录的列名行
2. **列名映射**：自动映射医保编码、药品编码等关键列
3. **创建映射字典**：药品编码到医保编码的映射关系
4. **匹配处理**：为药品使用信息添加医保编码
5. **数据过滤**：只保留成功匹配医保编码的记录

## 🚀 使用步骤

1. **选择必需文件**：选择4个必需的Excel文件
   - 药品使用信息（包含所有科室的药品使用明细）
   - 门急诊统计数据表
   - 住出院统计数据表
   - 中联软件药品目录

2. **配置可选文件**：根据需要勾选并选择科室结构总表

3. **选择通平台版本**：在下拉框中选择1.4或1.5版本

4. **设置时间参数**：输入时间（格式：2025年9月）

5. **设置输出位置**：选择输出文件的保存位置和名称

6. **开始处理**：点击"开始处理数据"按钮

7. **等待完成**：查看处理进度和日志信息

## ⚠️ 中联软件注意事项

### 数据文件要求
- **智能匹配优势**：系统具有强大的智能表头匹配功能，对中联软件导出的列名格式要求相对宽松
- **必须列完整性**：药品使用信息文件必须包含核心必须列（系统会自动识别列名变体）
- **数据行位置**：药品使用信息跳过前2行，药品目录支持智能表头检测
- **编码一致性**：中联软件药品目录用于医保编码匹配，确保药品编码一致性

### 中联软件特殊处理
- **列名特殊字符**：中联软件导出的Excel文件列名可能包含换行符(\n)和空格，系统会自动处理
- **数据格式变化**：中联软件不同版本可能导出不同格式的数据，系统具有强大的适应性
- **科室名称前缀**：中联软件可能在科室名称前添加英文前缀，系统会自动识别和处理
- **数据聚合需求**：中联软件导出的是明细数据，系统会自动按科室+药品进行聚合处理

### 系统使用注意
- **处理期间**：请勿关闭程序，系统会显示详细的处理进度
- **内存要求**：大数据量处理时确保内存充足
- **日志监控**：关注实时日志显示，了解智能匹配和处理状态
- **错误处理**：系统具有完善的容错机制，会自动处理常见的数据格式问题

### 输出特性
- **科室高亮**：新增科室在科室结构总表中自动标记为绿色高亮
- **ID格式保护**：确保科室ID保持正确的前导零格式
- **临时文件清理**：处理完成后自动清理临时文件

## 🆕 中联软件版本特性

### 核心优势
- **中联软件适配**：专门针对中联软件数据格式进行优化
- **智能表头匹配**：强大的自动表头检测和列名映射功能，完美适配中联软件导出格式
- **前置数据聚合**：自动聚合中联软件药品使用明细数据
- **动态科室识别**：采用先进的正则表达式和模式匹配算法，适配中联软件科室命名规则
- **智能医保编码匹配**：多层智能识别算法，提高中联软件数据匹配准确率
- **四级结构支持**：完整支持中联软件复杂的医院科室层级结构
- **版本兼容性**：支持通平台1.4和1.5版本的差异化处理

### 界面优化
- **Logo集成显示**：120x120像素高清logo，提升专业形象
- **颜色标识系统**：新增科室绿色高亮，一目了然
- **实时日志反馈**：详细的处理过程和错误信息显示
- **进度可视化**：直观的进度条显示处理状态

### 处理优化
- **多层智能检测**：药品目录和药品使用信息的双重智能表头检测
- **智能列映射**：增强的Excel列名识别和自动映射算法，专门适配中联软件
- **容错处理**：支持列名变体、特殊字符、数据类型自动转换
- **格式保护**：确保科室ID和编码格式的正确性
- **错误处理**：完善的异常处理和详细日志记录
- **性能优化**：优化大数据量处理性能

### 自动化功能
- **临时文件清理**：自动清理处理过程中的临时文件
- **科室结构维护**：动态维护科室结构总表
- **颜色标识管理**：自动跟踪和标识新增科室

## 📋 中联软件数据处理流程

### 1. 数据预处理阶段
1. **文件检测**：自动检测中联软件导出的Excel文件格式
2. **表头识别**：智能识别药品使用信息文件的表头行位置
3. **列名映射**：自动映射中联软件特有的列名格式
4. **数据清洗**：处理特殊字符和格式问题

### 2. 数据聚合阶段
1. **明细数据读取**：读取包含所有科室的药品使用明细数据
2. **科室药品聚合**：按接收科室+药品名称进行数据聚合
3. **金额数量汇总**：对实发数量和金额进行求和处理
4. **信息保留**：保留科室编码、药品id、规格等重要字段的第一个值

### 3. 科室结构识别阶段
1. **四级结构识别**：识别中联软件复杂的科室层级结构
2. **科室分类**：区分混合科室、门诊科室、住院科室
3. **ID分配**：为各级科室分配唯一的ID编码
4. **结构维护**：更新和维护科室结构总表

### 4. 医保编码匹配阶段
1. **药品目录解析**：解析中联软件药品目录文件
2. **编码映射**：建立药品编码到医保编码的映射关系
3. **匹配处理**：为药品使用信息添加医保编码
4. **数据过滤**：过滤无法匹配的数据记录

### 5. 输出生成阶段
1. **四表生成**：生成医院药品信息、药品使用信息、科室信息、药费及人次汇总四个工作表
2. **格式设置**：设置Excel格式和样式
3. **数据验证**：验证输出数据的完整性和准确性
4. **文件保存**：保存最终的标准化Excel文件

---

**版本**: 中联软件适配版  
**更新时间**: 2025年  
**开发说明**: 这个工具专门针对中联软件的数据格式和业务需求进行了深度优化，基于智能表头匹配、前置数据聚合和动态科室结构识别的医疗数据处理系统。系统的核心优势在于对中联软件导出数据格式的完美适配，能够自动识别和处理各种格式变化，大幅降低了用户的数据准备工作量。特别适合使用中联软件的医疗机构进行数据整理和上报工作。中联软件版本通过智能匹配、前置聚合处理和先进的算法技术，确保了数据处理的准确性和灵活性。