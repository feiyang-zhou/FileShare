<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通平台数据处理工具说明文档</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        h2 {
            color: #34495e;
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        h3 {
            color: #2c3e50;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        h4 {
            color: #34495e;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .emoji {
            font-size: 1.2em;
            margin-right: 8px;
        }
        ul, ol {
            margin-bottom: 15px;
            padding-left: 25px;
        }
        li {
            margin-bottom: 8px;
        }
        .highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            overflow-x: auto;
            font-size: 14px;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s ease;
        }
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .feature-card h4 {
            color: #495057;
            margin-top: 0;
            margin-bottom: 12px;
        }
        .step-list {
            counter-reset: step-counter;
            list-style: none;
            padding: 0;
        }
        .step-list li {
            counter-increment: step-counter;
            position: relative;
            padding-left: 40px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            padding: 15px 15px 15px 50px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #3498db;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .table-container {
            overflow-x: auto;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            background: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f0f8ff;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .toc {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .toc h3 {
            margin-top: 0;
            color: #495057;
        }
        .toc ul {
            columns: 2;
            column-gap: 30px;
        }
        .toc a {
            color: #3498db;
            text-decoration: none;
        }
        .toc a:hover {
            text-decoration: underline;
        }
        @media (max-width: 768px) {
            .toc ul {
                columns: 1;
            }
            .feature-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><span class="emoji">📋</span>通平台数据处理工具说明文档-陈莹版本</h1>

        <div class="toc">
            <h3>📋 目录导航</h3>
            <ul>
                <li><a href="#overview">工具概述</a></li>
                <li><a href="#features">功能特点</a></li>
                <li><a href="#requirements">数据要求</a></li>
                <li><a href="#formats">数据格式要求</a></li>
                <li><a href="#output">输出格式</a></li>
                <li><a href="#processing">特殊处理机制</a></li>
                <li><a href="#classification">门诊/住院判断标准</a></li>
                <li><a href="#structure">四级结构识别标准</a></li>
                <li><a href="#usage">使用步骤</a></li>
                <li><a href="#notes">注意事项</a></li>
                <li><a href="#version">版本特性</a></li>
            </ul>
        </div>

        <div id="overview">
            <h2><span class="emoji">📋</span>工具概述</h2>
            <p>通平台数据处理工具是一个专业的医疗数据标准化处理系统，能够将多个医疗相关的Excel文件转换为标准化的目标表格，支持复杂的科室结构识别和医保编码匹配。</p>
        </div>

        <div id="features">
            <h2><span class="emoji">🔧</span>功能特点</h2>
            
            <h3>1. 核心功能</h3>
            <ul>
                <li><strong>医疗数据标准化处理</strong>：将多个医疗相关Excel文件转换为标准化的目标表格</li>
                <li><strong>四工作表输出</strong>：生成包含4个工作表的Excel文件
                    <ul>
                        <li>医院药品信息表</li>
                        <li>药品使用信息表</li>
                        <li>科室信息表（支持四级结构）</li>
                        <li>药费及人次汇总表</li>
                    </ul>
                </li>
            </ul>

            <h3>2. 高级特性</h3>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>智能科室结构识别</h4>
                    <p>支持四级科室结构（如"心内科一病房"、"泌尿外科二区"）</p>
                </div>
                <div class="feature-card">
                    <h4>科室结构总表维护</h4>
                    <p>自动维护桌面科室结构总表，确保科室ID一致性</p>
                </div>
                <div class="feature-card">
                    <h4>医保编码智能匹配</h4>
                    <p>通过药品编码精确匹配医保编码</p>
                </div>
                <div class="feature-card">
                    <h4>前导零格式保护</h4>
                    <p>确保科室ID保持正确格式（如029000而非29000.0）</p>
                </div>
                <div class="feature-card">
                    <h4>新增科室高亮</h4>
                    <p>新增科室在总表中自动标记为绿色高亮</p>
                </div>
            </div>

            <h3>3. 用户界面特性</h3>
            <ul>
                <li><strong>图形化界面</strong>：友好GUI界面</li>
                <li><strong>实时日志显示</strong>：处理过程实时显示详细日志</li>
                <li><strong>进度条显示</strong>：可视化处理进度</li>
                <li><strong>文件自动检测</strong>：智能查找和识别数据文件</li>
            </ul>
        </div>

        <div id="requirements">
            <h2><span class="emoji">📁</span>数据要求</h2>
            
            <h3>必需文件（4个）</h3>
            <ol>
                <li><strong>科室药品使用金额及使用量DDDs排名表</strong>
                    <ul>
                        <li>格式：Excel文件（.xlsx/.xls）</li>
                        <li>包含科室药品使用数据和DDDs排名信息</li>
                    </ul>
                </li>
                <li><strong>门诊病人指标文件</strong>
                    <ul>
                        <li>格式：Excel文件</li>
                        <li>包含门诊患者统计数据</li>
                    </ul>
                </li>
                <li><strong>住院病人指标文件</strong>
                    <ul>
                        <li>格式：Excel文件</li>
                        <li>包含住院患者统计数据</li>
                    </ul>
                </li>
                <li><strong>公立医疗机构药品目录</strong>
                    <ul>
                        <li>格式：Excel文件</li>
                        <li>用于医保编码映射和药品信息匹配</li>
                    </ul>
                </li>
            </ol>

            <h3>可选文件（2个）</h3>
            <ol>
                <li><strong>住院患者静脉输液使用监测指标调查表</strong>
                    <ul>
                        <li>用于计算平均住院天数和住院总人天数</li>
                    </ul>
                </li>
                <li><strong>科室结构总表</strong>
                    <ul>
                        <li>自定义科室结构，不选择时使用桌面默认表</li>
                    </ul>
                </li>
            </ol>
        </div>

        <div id="formats">
            <h2><span class="emoji">📊</span>数据格式要求</h2>
            
            <h3>科室药品使用数据表必须列</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>列名</th>
                            <th>说明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>排名</td><td>药品排名信息</td></tr>
                        <tr><td>科室名称</td><td>科室完整名称</td></tr>
                        <tr><td>科室药品总金额</td><td>科室药品总费用</td></tr>
                        <tr><td>药品排名</td><td>具体药品排名</td></tr>
                        <tr><td>药品名称</td><td>药品完整名称</td></tr>
                        <tr><td>药品编码</td><td>院内药品唯一标识码</td></tr>
                        <tr><td>医保编码</td><td>国家医保统一编码</td></tr>
                        <tr><td>药品通用名</td><td>药品通用名称</td></tr>
                        <tr><td>剂型</td><td>药品剂型信息</td></tr>
                        <tr><td>规格</td><td>药品规格描述</td></tr>
                        <tr><td>厂家</td><td>生产厂家信息</td></tr>
                        <tr><td>使用量DDDs</td><td>DDDs使用量数据</td></tr>
                        <tr><td>数量</td><td>使用数量（支持"114+-120"等格式）</td></tr>
                        <tr><td>计价单位</td><td>计价单位</td></tr>
                        <tr><td>单价</td><td>药品单价</td></tr>
                        <tr><td>总金额</td><td>使用总金额</td></tr>
                    </tbody>
                </table>
            </div>

            <h3>公立医疗机构药品目录格式</h3>
            <p>支持一种格式：</p>
            <ol>
                <li><strong>三列格式</strong>：[药品编码, 药品名称, 医保编码]</li>
            </ol>

            <h3>科室名称格式要求</h3>
            <ul>
                <li>支持英文前缀自动去除（如"A-心内科"→"心内科"）</li>
                <li>支持门诊/住院/病房后缀识别</li>
                <li>支持四级结构识别：
                    <ul>
                        <li>数字+病房：心内科一病房、心内科2病房</li>
                        <li>数字+区：心内科一区、心内科2区</li>
                        <li>数字+科：心内科一科、心内科2科</li>
                        <li>数字+病区：心内科一病区、心内科2病区</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div id="output">
            <h2><span class="emoji">🎯</span>输出格式</h2>
            
            <h3>输出文件结构</h3>
            <ul>
                <li><strong>文件格式</strong>：Excel文件（.xlsx）</li>
                <li><strong>工作表数量</strong>：4个</li>
                <li><strong>默认保存位置</strong>：桌面/结果文件/文件夹</li>
                <li><strong>文件命名</strong>：目标表格_时间戳.xlsx</li>
            </ul>

            <h3>各工作表内容</h3>
            <ol>
                <li><strong>医院药品信息</strong>：医院药品基础信息表</li>
                <li><strong>药品使用信息</strong>：详细的药品使用记录</li>
                <li><strong>科室信息</strong>：科室层级结构（包含单元格合并）</li>
                <li><strong>药费及人次</strong>：按科室汇总的费用和人次统计</li>
            </ol>
        </div>

        <div id="processing">
            <h2><span class="emoji">⚙️</span>特殊处理机制</h2>
            
            <h3>智能列名检测</h3>
            <ul>
                <li>自动检测Excel文件中的真正列名行</li>
                <li>支持跳过标题行和空行</li>
                <li>智能匹配关键词进行列名识别</li>
            </ul>

            <h3>ID格式保护</h3>
            <ul>
                <li>确保科室ID保持前导零格式</li>
                <li>防止Excel自动转换为数字格式</li>
                <li>支持多种ID长度（2位、3位、4位、5位、6位、7位）</li>
            </ul>

            <h3>数据类型兼容</h3>
            <ul>
                <li>支持浮点数格式的编码转换</li>
                <li>处理"106079.0"→"106079"的格式转换</li>
                <li>支持多种编码格式的映射匹配</li>
            </ul>
        </div>

        <div id="classification">
            <h2><span class="emoji">🏥</span>门诊/住院判断标准</h2>
            
            <h3>判断逻辑（按优先级）</h3>
            <div class="code-block">
def determine_dept_type(dept_name):
    if pd.isna(dept_name):
        return ''
    dept_str = str(dept_name).strip()
    
    # 1. 以"门诊"结尾的科室 → 门诊
    if dept_str.endswith('门诊'):
        return '门诊'
    # 2. 以"住院"结尾的科室 → 住院  
    elif dept_str.endswith('住院'):
        return '住院'
    # 3. 以"病房"结尾的科室 → 住院
    elif dept_str.endswith('病房'):
        return '住院'
    # 4. 其他科室 → 默认为门诊
    else:
        return '门诊'
            </div>

            <h3>具体判断标准</h3>
            
            <h4>门诊科室识别</h4>
            <ul>
                <li><strong>明确标识</strong>：科室名称以"门诊"结尾
                    <ul>
                        <li>示例：<code>心内科门诊</code>、<code>神经内科门诊</code>、<code>肿瘤门诊</code></li>
                    </ul>
                </li>
                <li><strong>默认归类</strong>：不以"住院"或"病房"结尾的科室默认为门诊
                    <ul>
                        <li>示例：<code>心内科</code>、<code>神经内科</code>、<code>检验科</code>、<code>放射科</code></li>
                    </ul>
                </li>
            </ul>

            <h4>住院科室识别</h4>
            <ul>
                <li><strong>住院标识</strong>：科室名称以"住院"结尾
                    <ul>
                        <li>示例：<code>心内科住院</code>、<code>神经内科住院</code>、<code>MICU住院</code></li>
                    </ul>
                </li>
                <li><strong>病房标识</strong>：科室名称以"病房"结尾
                    <ul>
                        <li>示例：<code>心内科病房</code>、<code>神经内科病房</code>、<code>心内科一病房</code></li>
                    </ul>
                </li>
            </ul>
        </div>

        <div id="structure">
            <h2><span class="emoji">🏗️</span>四级结构识别标准</h2>
            
            <h3>识别原理</h3>
            <p>四级结构用于识别同一基础科室下的多个病房或科室单元，如"心内科一病房"、"心内科二病房"等。</p>

            <h3>白名单排除机制</h3>
            <p>以下科室即使匹配四级结构模式，也<strong>不会</strong>被识别为四级结构：</p>
            <div class="code-block">
whitelist_depts = [
    'MICU住院', 'SICU住院', 'LDR住院', 'CT室',
    'MICU', 'SICU', 'LDR',  # 不带住院后缀的版本
    'ICU住院', 'ICU', 'NICU住院', 'NICU',  # 其他ICU类科室
    'MRI室', 'DR室', 'DSA室', 'B超室',  # 医技科室
]
            </div>

            <h3>特殊处理科室</h3>
            <div class="code-block">
# 消化内科特殊四级结构
digestive_whitelist = {
    '消化内科住院': ('消化内科', '消化内科住院', '住院', '消化内科'),
    '消化内科二住院': ('消化内科', '消化内科二住院', '住院', '消化内科')
}
            </div>

            <h3>四级结构识别模式</h3>
            
            <h4>1. 正则表达式模式</h4>
            <div class="code-block">
fourth_level_patterns = [
    # 模式1: 科室名+数字+后缀
    r'(.+?)(一|二|三|四|五|六|七|八|九|十|1|2|3|4|5|6|7|8|9|10|11|12)(病房|区|科|病区|监护室|重症|ICU)',
    # 模式2: 科室名+纯数字或中文数字结尾
    r'(.+?)(一|二|三|四|五|六|七|八|九|十|1|2|3|4|5|6|7|8|9|10|11|12)$'$'
]
            </div>

            <h4>2. 具体识别标准</h4>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>支持的数字标识</h4>
                    <ul>
                        <li><strong>中文数字</strong>：一、二、三、四、五、六、七、八、九、十</li>
                        <li><strong>阿拉伯数字</strong>：1、2、3、4、5、6、7、8、9、10、11、12</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <h4>支持的后缀标识</h4>
                    <ul>
                        <li><strong>病房</strong>：心内科一病房、心内科2病房</li>
                        <li><strong>区</strong>：心内科一区、心内科2区</li>
                        <li><strong>科</strong>：心内科一科、心内科2科</li>
                        <li><strong>病区</strong>：心内科一病区、心内科2病区</li>
                        <li><strong>监护室</strong>：心内科一监护室</li>
                        <li><strong>重症</strong>：心内科一重症</li>
                        <li><strong>ICU</strong>：心内科一ICU</li>
                    </ul>
                </div>
            </div>

            <h3>四级结构识别示例</h3>
            
            <h4><span class="success">✅ 会被识别为四级结构的科室</span></h4>
            <div class="code-block">
心内科一病房 → 基础科室: 心内科, 子单元: 一病房
心内科二病房 → 基础科室: 心内科, 子单元: 二病房
泌尿外科1区 → 基础科室: 泌尿外科, 子单元: 1区
神经内科三科 → 基础科室: 神经内科, 子单元: 三科
骨科2病区 → 基础科室: 骨科, 子单元: 2病区
心内科一监护室 → 基础科室: 心内科, 子单元: 一监护室
消化内科二住院 → 基础科室: 消化内科, 子单元: 消化内科二住院 (特殊处理)
            </div>

            <h4><span class="error">❌ 不会被识别为四级结构的科室</span></h4>
            <div class="code-block">
MICU住院 → 白名单排除，识别为三级结构
SICU住院 → 白名单排除，识别为三级结构
CT室 → 白名单排除，识别为三级结构
心内科门诊 → 无数字标识，识别为三级结构
神经内科住院 → 无数字标识，识别为三级结构
            </div>

            <h3>四级结构处理逻辑</h3>
            
            <h4>1. 结构层级</h4>
            <ul>
                <li><strong>一级结构</strong>：全院合计 (ID: 01)</li>
                <li><strong>二级结构</strong>：基础科室或科室组 (ID: 001, 002, ...)</li>
                <li><strong>三级结构</strong>：具体科室类型 (ID: 0010, 0011, ...)</li>
                <li><strong>四级结构</strong>：科室子单元 (ID: 00101, 00102, ...)</li>
            </ul>

            <h4>2. ID分配规则</h4>
            <div class="code-block">
# 混合科室（既有门诊又有住院）
门诊三级ID = f"{二级ID}0"  # 如: 0010
住院三级ID = f"{二级ID}1"  # 如: 0011
四级ID = f"{三级ID}{计数器}"  # 如: 00101, 00102

# 其他门诊组
三级ID = f"{二级ID}{计数器:03d}"  # 如: 001001

# 其他住院组  
三级ID = f"{二级ID}{计数器:03d}"  # 如: 002001
四级ID = f"{三级ID}{计数器:01d}"  # 如: 0020011
            </div>

            <h4>3. 科室归类逻辑</h4>
            <ul>
                <li><strong>混合科室</strong>：同时有门诊和住院的基础科室保持独立二级结构</li>
                <li><strong>其他门诊</strong>：仅有门诊的科室归入"其他门诊"二级结构</li>
                <li><strong>其他住院</strong>：仅有住院的科室归入"其他住院"二级结构</li>
                <li><strong>其他病房</strong>：仅有四级结构住院科室的基础科室归入"其他病房"二级结构</li>
            </ul>

            <h3>实际应用示例</h3>
            
            <h4>示例1：心内科（混合科室+四级结构）</h4>
            <div class="highlight">
                <strong>原始数据:</strong> 心内科门诊, 心内科一病房, 心内科二病房<br><br>
                <strong>处理结果:</strong><br>
                - 二级结构: 心内科 (ID: 001)<br>
                - 三级结构: 心内科门诊 (ID: 0010), 心内科病房 (ID: 0011)<br>
                - 四级结构: 心内科一病房 (ID: 00111), 心内科二病房 (ID: 00112)
            </div>

            <h4>示例2：泌尿外科（仅四级结构住院）</h4>
            <div class="highlight">
                <strong>原始数据:</strong> 泌尿外科一病房, 泌尿外科二区<br><br>
                <strong>处理结果:</strong><br>
                - 二级结构: 其他病房 (ID: 010)<br>
                - 三级结构: 泌尿外科病房 (ID: 010001)<br>
                - 四级结构: 泌尿外科一病房 (ID: 0100011), 泌尿外科二区 (ID: 0100012)
            </div>
        </div>

        <div id="usage">
            <h2><span class="emoji">🚀</span>使用步骤</h2>
            
            <ol class="step-list">
                <li><strong>选择必需文件</strong>：选择4个必需的Excel文件</li>
                <li><strong>配置可选文件</strong>：根据需要勾选并选择可选文件</li>
                <li><strong>设置时间参数</strong>：输入时间（格式：2025年9月）</li>
                <li><strong>设置输出位置</strong>：选择输出文件的保存位置和名称</li>
                <li><strong>开始处理</strong>：点击"开始处理数据"按钮</li>
                <li><strong>等待完成</strong>：查看处理进度和日志信息</li>
            </ol>
        </div>

        <div id="notes">
            <h2><span class="emoji">⚠️</span>注意事项</h2>
            
            <div class="warning">
                <ul>
                    <li>确保输入文件格式正确</li>
                    <li>处理期间请勿关闭程序</li>
                    <li>大数据量处理时确保内存充足</li>
                    <li>新增科室在科室结构总表中自动标记为绿色高亮</li>
                    <li>智能白名单机制：肿瘤门诊和神经内科门诊特殊处理</li>
                    <li>白名单科室如在总表中已存在，将不会被重复高亮</li>
                </ul>
            </div>
        </div>

        <div id="version">
            <h2><span class="emoji">🆕</span>版本特性</h2>
            
            <div class="info">
                <ul>
                    <li>支持可选文件配置</li>
                    <li>住院患者静脉输液监测表处理</li>
                    <li>自动计算平均住院天数和住院总人天数</li>
                    <li>自定义科室结构总表支持</li>
                    <li>高亮显示功能：新增科室自动标记为绿色高亮</li>
                    <li>确保高亮显示的准确性，避免误标记</li>
                </ul>
            </div>
        </div>

        <hr style="margin: 40px 0; border: none; border-top: 2px solid #eee;">
        
        <div style="text-align: center; color: #666; font-size: 14px;">
            <p><strong>版本</strong>: 2.0.0</p>
            <p><strong>更新时间</strong>: 2025年</p>
            <p><strong>开发说明</strong>: 这个工具是一个功能完整的医疗数据处理系统，具有强大的数据标准化和格式转换能力，特别适合医疗机构进行数据整理和上报工作。</p>
        </div>
    </div>
</body>
</html>