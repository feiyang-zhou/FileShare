# DDS表医保贯标码处理逻辑说明文档

## 概述

本文档详细说明了医疗数据处理脚本中新增的DDS表医保贯标码判断逻辑，包括数据处理流程、逻辑分支和具体的数据映射规则。

## 功能需求

### 核心需求
当输入的DDS表包含医保贯标码列且该列有数据时：
1. **忽略公立医院对应关系表**：即使用户传入了公立医院对应关系表，也会被忽略
2. **跳过格式校验**：任何表都能通过处理，包括传入DDS表作为占位符
3. **直接数据映射**：从DDS表直接提取所需数据，不进行额外的匹配处理

## 数据处理逻辑

### 1. 检测阶段

#### 1.1 医保贯标码列检测
脚本会自动检测DDS表中是否存在以下列名：
- `医保贯标码`
- `医保编码` 
- `统一编码`
- `国家编码`

#### 1.2 数据有效性验证
检测到相关列名后，会验证该列是否包含有效数据：
- 检查非空值数量
- 排除空字符串和'nan'值
- 至少需要1条有效数据才启用新逻辑

### 2. 逻辑分支判断

```
if DDS表包含医保贯标码列 AND 该列有有效数据:
    启用DDS表模式
else:
    使用传统处理模式
```

### 3. DDS表模式处理逻辑

#### 3.1 公立医院对应关系表处理
- **状态**：完全忽略
- **行为**：即使用户传入了公立医院对应关系表文件，系统也不会读取或使用
- **占位符机制**：用户可以传入任何表文件作为占位符，包括DDS表本身

#### 3.2 格式校验
- **状态**：跳过所有格式校验
- **行为**：任何Excel表格都能通过处理，不进行列名、数据格式等校验

#### 3.3 数据映射规则

##### 医院药品信息表数据来源
| 目标列 | 数据来源 | 说明 |
|--------|----------|------|
| 医保编码 | DDS表的医保贯标码列 | 直接映射 |
| 医院药品ID | DDS表的药品编码列 | 确保字符串格式，去除.0后缀 |
| 药品名称 | DDS表的药品名称列 | 直接映射 |
| 规格或规格x包装 | DDS表的规格列 | 直接映射 |
| 规格转换系数 | 默认值：1 | 固定值 |
| 成本价格(元) | 默认值：空 | 固定值 |

##### 药品使用信息表数据来源
| 目标列 | 数据来源 | 说明 |
|--------|----------|------|
| 医保编码 | DDS表的医保贯标码列 | 直接映射 |
| 医院药品ID | DDS表的药品编码列 | 确保字符串格式，去除.0后缀 |
| 使用量 | DDS表的数量列 | 直接映射 |
| 使用金额 | DDS表的总金额(元)列 | 直接映射 |

### 4. 传统模式处理逻辑

当DDS表不包含医保贯标码或该列为空时，系统按原有逻辑处理：
1. 读取公立医院对应关系表
2. 进行格式校验
3. 通过药品编码进行匹配映射



## 数据流程图

```
开始
  ↓
读取DDS表
  ↓
检测医保贯标码列
  ↓
医保贯标码列有数据？
  ↓                ↓
 是                 否
  ↓                ↓
DDS表模式          传统模式
  ↓                ↓
忽略对应关系表      读取对应关系表
  ↓                ↓
跳过格式校验        进行格式校验
  ↓                ↓
直接数据映射        药品编码匹配
  ↓                ↓
生成目标表格 ←——————┘
  ↓
结束
```

## 使用场景

### 场景1：DDS表包含医保贯标码
- **输入**：包含医保贯标码列的DDS表 + 任意占位符表（可选）
- **处理**：DDS表模式，直接数据映射
- **输出**：医保编码来自医保贯标码列，医院药品ID来自药品编码列

### 场景2：DDS表不包含医保贯标码
- **输入**：普通DDS表 + 公立医院对应关系表（必需）
- **处理**：传统模式，药品编码匹配
- **输出**：医保编码通过药品编码匹配获得