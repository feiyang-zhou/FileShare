# 通平台数据处理工具说明文档（沙其版本）

## 📋 工具概述

通平台数据处理工具（沙其版本）是一个专业的医疗数据标准化处理系统，能够将多个医疗相关的Excel文件转换为标准化的目标表格，支持复杂的科室结构识别和医保编码匹配。本版本采用预定义的科室架构配置，确保科室分类的一致性和准确性。

## 🔧 功能特点

### 1. 核心功能
- **医疗数据标准化处理**：将多个医疗相关Excel文件转换为标准化的目标表格
- **四工作表输出**：生成包含4个工作表的Excel文件
  - 医院药品信息表
  - 药品使用信息表  
  - 科室信息表（支持四级结构）
  - 药费及人次汇总表

### 2. 高级特性
- **预定义科室架构系统**：采用固化的科室架构配置，包含582个科室记录
- **智能科室层级识别**：支持主科室与亚专业科室的自动识别和分类
- **科室结构总表维护**：自动维护桌面科室结构总表，确保科室ID一致性
- **医保编码智能匹配**：通过药品编码精确匹配医保编码
- **前导零格式保护**：确保科室ID保持正确格式（如029000而非29000.0）
- **新增科室高亮**：新增科室在总表中自动标记为绿色高亮

### 3. 用户界面特性
- **图形化界面**：基于Tkinter的友好GUI界面
- **实时日志显示**：处理过程实时显示详细日志
- **进度条显示**：可视化处理进度
- **文件自动检测**：智能查找和识别数据文件
- **版本选择支持**：支持通平台1.4和1.5版本切换

## 🏥 沙其版本特色：预定义科室架构

### 科室架构统计
- **主科室总数**：约120个主科室分组
- **亚专业科室总数**：582个详细科室记录
- **门诊科室**：包含各类专科门诊、专病门诊、联合门诊等
- **住院科室**：涵盖各病区、护理单元、重症监护室等

### 主要科室分类示例

#### 门诊科室（带"+"标识的主科室）
- **儿科+**：包含35个亚专业科室
  - 儿科(儿童肥胖)门诊、儿科(小儿心血管系统)门诊等
- **内分泌科+**：包含21个亚专业科室
  - 内分泌科(糖尿病足)门诊、内分泌科(甲状腺眼病)门诊等
- **呼吸与危重症医学科+**：包含17个亚专业科室
  - 呼吸内科(哮喘专病)门诊、呼吸内科(肺癌与肺部小结节)门诊等
- **皮肤科+**：包含20个亚专业科室
  - 皮肤科(白癜风及色素性皮肤病)门诊、皮肤科(激光及注射)门诊等

#### 住院科室（无"+"标识）
- **心血管内科**：心血管内科A区、B区、C区及对应护理单元
- **神经内科**：神经内科A区、B区、C区及重症监护病房
- **肿瘤内科**：肿瘤内科A区、B区、C区及日间化疗病房
- **骨科**：骨科A区、B区、C区及对应护理单元

#### 特殊科室分类
- **特需门诊**：包含23个特需专科门诊
- **急诊科+**：包含11个急诊专科
- **中医科+**：包含16个中医专科门诊
- **蒙医科+**：包含10个蒙医特色门诊

### 科室架构识别逻辑

#### 1. 主科室识别
系统根据预定义的科室架构表自动识别主科室：
```python
# 主科室示例
main_departments = [
    "儿科+", "内分泌科+", "呼吸与危重症医学科+", 
    "心血管内科", "神经内科", "肿瘤内科"
]
```

#### 2. 亚专业科室识别
每个主科室下包含多个亚专业科室：
```python
# 亚专业科室示例
sub_departments = {
    "儿科+": [
        "儿科(儿童肥胖)门诊",
        "儿科(小儿心血管系统)门诊",
        "儿科门诊"
    ]
}
```

#### 3. 动态推断机制
对于架构表中未明确定义的科室，系统提供智能推断：
- **关键词匹配**：根据科室名称中的关键词推断主科室
- **模式识别**：识别括号、专科标识等模式
- **默认分类**：未识别科室归入相应的默认分组

## 📁 数据要求

### 必需文件（4个）
1. **科室药品使用金额及使用量DDDs排名表**
   - 格式：Excel文件（.xlsx/.xls）
   - 包含科室药品使用数据和DDDs排名信息

2. **门诊病人指标文件**
   - 格式：Excel文件
   - 包含门诊患者统计数据

3. **住院病人指标文件**
   - 格式：Excel文件
   - 包含住院患者统计数据

4. **公立医疗机构药品目录**
   - 格式：Excel文件
   - 用于医保编码映射和药品信息匹配

### 可选文件（2个）
1. **住院患者静脉输液使用监测指标调查表**
   - 用于计算平均住院天数和住院总人天数

2. **科室结构总表**
   - 自定义科室结构，不选择时使用桌面默认表

## 📊 数据格式要求

### 科室药品使用数据表必须列
- **排名**：药品排名信息
- **科室名称**：科室完整名称
- **科室药品总金额**：科室药品总费用
- **药品排名**：具体药品排名
- **药品名称**：药品完整名称
- **药品编码**：院内药品唯一标识码
- **医保编码**：国家医保统一编码
- **药品通用名**：药品通用名称
- **剂型**：药品剂型信息
- **规格**：药品规格描述
- **厂家**：生产厂家信息
- **使用量DDDs**：DDDs使用量数据
- **数量**：使用数量（支持"114+-120"等格式）
- **计价单位**：计价单位
- **单价**：药品单价（可选列，支持15列和16列格式）
- **总金额**：使用总金额

### 公立医疗机构药品目录格式

#### 必需列（4个）
1. **医保编码列** - 必须包含以下关键词之一：
   - "医保编码"
   - "医保" + "编码"
   - "统一编码"
   - "国家编码"
   - "编码"
   - "医保"

2. **药品编码列** - 必须包含以下关键词之一：
   - "院内药品唯一码"
   - "药品唯一码"
   - "院内编码"
   - "药品编码"
   - "内部编码"
   - "唯一码"
   - "药品"

3. **产品名称列** - 必须包含以下关键词之一：
   - "产品名称"
   - "药品名称"
   - "通用名"
   - "名称"

4. **规格列** - 包含以下关键词之一：
   - "制剂规格"
   - "规格"
   - "包装规格"
   - "药品规格"

#### 重要说明
- **智能识别**：系统通过列名中的关键词自动识别列，不依赖固定的列位置
- **最低要求**：至少需要前3个必需列才能正常处理
- **匹配逻辑**：
  - 优先进行严格匹配（列名包含所有关键词）
  - 如果严格匹配失败，则进行部分匹配（列名包含任意关键词）
- **数据质量**：每行数据中这些列都应该有有效值，空值或"nan"会被跳过

#### 示例列名
```
✅ 有效的列名示例：
- 医保编码、国家医保编码、统一医保编码
- 院内药品唯一码、药品编码、内部药品编码
- 产品名称、药品名称、药品通用名
- 制剂规格、药品规格、包装规格

❌ 无效的列名示例：
- 序号、ID、编号（太模糊）
- 备注、说明（不相关）
- Unnamed: 0（Excel默认列名）
```

**注意**：沙其版本不支持简单的三列格式，需要通过智能列名识别自动匹配相应的列。

### 科室名称格式要求
- 支持英文前缀自动去除（如"A-心内科"→"心内科"）
- 支持门诊/住院/病房后缀识别
- 集成预定义科室架构，优先使用架构表中的分类
- 支持动态推断未知科室的主科室归属

## 🎯 输出格式

### 输出文件结构
- **文件格式**：Excel文件（.xlsx）
- **工作表数量**：4个
- **默认保存位置**：桌面/结果文件/文件夹
- **文件命名**：目标表格_时间戳.xlsx

### 各工作表内容
1. **医院药品信息**：医院药品基础信息表
2. **药品使用信息**：详细的药品使用记录
3. **科室信息**：科室层级结构（包含单元格合并）
4. **药费及人次**：按科室汇总的费用和人次统计

## ⚙️ 特殊处理机制

### 智能列名检测
- 自动检测Excel文件中的真正列名行
- 支持跳过标题行和空行
- 智能匹配关键词进行列名识别

### ID格式保护
- 确保科室ID保持前导零格式
- 防止Excel自动转换为数字格式
- 支持多种ID长度（2位、3位、4位、5位、6位、7位）

### 数据类型兼容
- 支持浮点数格式的编码转换
- 处理"106079.0"→"106079"的格式转换
- 支持多种编码格式的映射匹配
- 兼容15列和16列的DDS表格式

## 🏥 门诊/住院判断标准

### 判断逻辑（按优先级）
```python
def determine_dept_type(dept_name):
    if pd.isna(dept_name):
        return ''
    dept_str = str(dept_name).strip()
    
    # 特殊情况：急诊科归类为门诊
    if dept_str == '急诊科':
        return '门诊'
    
    # 1. 以"门诊"结尾的科室 → 门诊
    if '门诊' in dept_str:
        return '门诊'
    # 2. 其他科室 → 默认为住院
    else:
        return '住院'
```

### 具体判断标准

#### 门诊科室识别
- **明确标识**：科室名称包含"门诊"
  - 示例：`心内科门诊`、`神经内科门诊`、`肿瘤门诊`
- **特殊处理**：急诊科归类为门诊

#### 住院科室识别
- **默认归类**：不包含"门诊"的科室默认为住院
  - 示例：`心内科A区`、`神经内科病房`、`ICU`

## 🏗️ 科室架构集成处理

### 架构优先原则
沙其版本优先使用预定义的科室架构进行科室分类：

1. **架构表查找**：首先在预定义架构表中查找科室
2. **精确匹配**：对于架构表中的科室，使用预定义的主科室分类
3. **智能推断**：对于架构表外的科室，使用推断算法确定分类
4. **动态更新**：新识别的科室动态添加到分类系统中

### 科室分组逻辑

#### 主科室分组
- **混合科室**：同时有门诊和住院的基础科室保持独立二级结构
- **其他门诊**：仅有门诊的科室归入"其他门诊"二级结构
- **其他住院**：仅有住院的科室归入"其他住院"二级结构
- **架构科室**：预定义架构中的科室按架构分类

#### ID分配规则
```python
# 混合科室（既有门诊又有住院）
门诊三级ID = f"{二级ID}0"  # 如: 0010
住院三级ID = f"{二级ID}1"  # 如: 0011

# 其他门诊组
三级ID = f"{二级ID}{计数器:03d}"  # 如: 001001

# 其他住院组  
三级ID = f"{二级ID}{计数器:03d}"  # 如: 002001
```

## 🔧 版本特性

### 通平台版本支持
- **1.4版本**：使用"规格转换系数"列名
- **1.5版本**：使用"规格转换系数（非包装转换比）"列名
- **动态切换**：GUI界面支持版本选择

### 数据兼容性
- **15列DDS表**：兼容缺少单价列的格式
- **16列DDS表**：支持完整的DDS表格式
- **智能检测**：自动识别并适配不同的列数格式

## 🚀 使用步骤

1. **选择必需文件**：选择4个必需的Excel文件
2. **配置可选文件**：根据需要勾选并选择可选文件
3. **选择通平台版本**：在下拉框中选择1.4或1.5版本
4. **设置时间参数**：输入时间（格式：2025年9月）
5. **设置输出位置**：选择输出文件的保存位置和名称
6. **开始处理**：点击"开始处理数据"按钮
7. **等待完成**：查看处理进度和日志信息

## ⚠️ 注意事项

- 确保输入文件格式正确
- 处理期间请勿关闭程序
- 大数据量处理时确保内存充足
- 新增科室在科室结构总表中自动标记为绿色高亮
- 预定义科室架构确保分类的一致性和准确性
- 支持15列和16列两种DDS表格式

## 🆕 沙其版本特性

### 核心优势
- **固化科室架构**：采用预定义的582个科室记录，确保分类准确性
- **智能科室识别**：结合架构表和推断算法，提高科室分类准确率
- **版本兼容性**：支持通平台1.4和1.5版本的差异化处理
- **数据格式兼容**：支持多种DDS表格式，提高数据处理灵活性

### 架构管理
- **JSON配置文件**：科室架构存储在dept_structure.json中
- **PyInstaller兼容**：解决打包后的路径问题
- **动态加载**：支持运行时加载和更新科室架构
- **统计功能**：提供详细的科室架构统计信息

### 处理优化
- **智能列检测**：增强的Excel列名识别算法
- **格式保护**：确保科室ID和编码格式的正确性
- **错误处理**：完善的异常处理和日志记录
- **性能优化**：优化大数据量处理性能

---

**版本**: 2.0.0（沙其版本）  
**更新时间**: 2025年  
**开发说明**: 这个工具是基于预定义科室架构的医疗数据处理系统，具有强大的数据标准化和格式转换能力，特别适合需要标准化科室分类的医疗机构进行数据整理和上报工作。沙其版本通过固化科室架构配置，确保了科室分类的一致性和准确性。